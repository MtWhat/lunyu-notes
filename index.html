<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibeè«–èª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* now editing */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f5f5f0;
            color: #2d2a26;
        }
        /* Ruby Text Styling for Zhuyin */
        ruby {
            ruby-position: over;
            font-family: 'Noto Serif TC', serif;
        }
        rt {
            font-size: 0.6em;
            font-family: 'Noto Sans TC', sans-serif; /* Zhuyin looks better in Sans */
            font-weight: normal;
            color: #57534e;
            transform: translateY(-2px);
        }

        .highlight {
            background-color: #fde047;
            font-weight: bold;
            border-radius: 2px;
            padding: 0 2px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        .search-container {
            backdrop-filter: blur(10px);
            background-color: rgba(245, 245, 240, 0.95);
        }
        .markdown-body p {
            margin-bottom: 0.8em;
        }

        /* Tags */
        .char-tag {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            background-color: #e7e5e4;
            color: #44403c;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
        }
        .char-tag:hover, .char-tag.active {
            background-color: #78716c;
            color: white;
        }

        /* Category-specific Tag Styles */
        .char-tag.tag-confucian {
            background-color: #fef3c7; /* amber-100 */
            color: #92400e; /* amber-800 */
        }
        .char-tag.tag-confucian:hover, .char-tag.tag-confucian.active {
            background-color: #d97706; /* amber-600 */
            color: white;
        }

        .char-tag.tag-other {
            background-color: #f5f5f4; /* stone-100 */
            color: #a8a29e; /* stone-400 */
        }
        .char-tag.tag-other:hover, .char-tag.tag-other.active {
            background-color: #78716c; /* stone-500 */
            color: white;
        }

        .char-tag.tag-ancient {
            background-color: #f1f5f9; /* slate-100 */
            color: #94a3b8; /* slate-400 */
        }
        .char-tag.tag-ancient:hover, .char-tag.tag-ancient.active {
            background-color: #64748b; /* slate-500 */
            color: white;
        }

        .char-tag.tag-lu {
            background-color: #ecfccb; /* lime-100 */
            color: #3f6212; /* lime-800 */
        }
        .char-tag.tag-lu:hover, .char-tag.tag-lu.active {
            background-color: #65a30d; /* lime-600 */
            color: white;
        }

        .char-tag.tag-foreign {
            background-color: #e0f2fe; /* sky-100 */
            color: #075985; /* sky-800 */
        }
        .char-tag.tag-foreign:hover, .char-tag.tag-foreign.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
        }

        /* Serial Number Style */
        .serial-num {
            font-family: 'Noto Sans TC', sans-serif;
            color: #a8a29e;
            font-weight: 300;
        }

        /* Tooltip Styling */
        #tooltip {
            position: absolute;
            background-color: #292524; /* stone-800 */
            color: #f5f5f4; /* stone-100 */
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: 'Noto Sans TC', sans-serif;
            z-index: 100;
            pointer-events: none; /* Prevent tooltip from interfering with clicks */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 250px;
            display: none;
            line-height: 1.5;
        }

        .rare-char {
            cursor: help;
            border-bottom: 1px dotted #a8a29e;
            transition: background-color 0.2s;
        }
        .rare-char:hover {
            background-color: #e7e5e4;
            border-radius: 2px;
        }

        /* Hashtag Styling */
        .hashtag {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            /* background-color: #e0e7ff; indigo-100 */
            color: #3730a3; /* indigo-800 */
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            margin-right: 4px;
        }
        .hashtag:hover, .hashtag.active {
            /* background-color: #4338ca; */ /* indigo-700 */
            color: blue;
        }

        /* Translation Styling */
        .translation-text {
            font-family: 'Noto Sans TC', sans-serif;
            color: #57534e; /* stone-600 */
            font-size: 1rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #d6d3d1; /* stone-300 */
            line-height: 1.6;
            display: none; /* Default hidden */
        }

        /* Show translations when parent has this class */
        .show-translations .translation-text {
            display: block;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .category-padding {
            padding-top: 1.52rem;
            padding-bottom: 1.5rem;
        }

        /* Pokemon Card Scroll Container */
        .card-scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 1.5rem;
            padding: 2rem;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            align-items: center;
            height: 100%;
        }

        .card-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .card-scroll-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .card-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .card-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .pokemon-card {
            flex: 0 0 auto;
            width: 300px;
            height: 480px;
            scroll-snap-align: center;
            background: linear-gradient(135deg, #fdfbf7 0%, #e7e5e4 100%);
            border-radius: 15px;
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 0 8px #d6d3d1; /* Inner border frame */
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #a8a29e;
        }

        .pokemon-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        /* Holographic effect for high rarity */
        .pokemon-card.rare-5::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(125deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.4) 40%, rgba(255,255,255,0) 50%);
            pointer-events: none;
            z-index: 2;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px 4px 16px;
            z-index: 1;
        }

        .card-image-container {
            margin: 4px 16px;
            height: 180px;
            background-color: #f5f5f4;
            border: 2px solid #d6d3d1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .card-content {
            padding: 8px 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
            overflow-y: auto;
        }

        .card-footer {
            padding: 12px 16px;
            border-top: 1px solid #d6d3d1;
            background-color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            color: #57534e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Header & Search -->
    <header class="w-full max-w-4xl sticky top-0 z-40 search-container shadow-sm border-b border-stone-300 p-4 transition-all">
        <div class="flex flex-wrap justify-between items-center gap-y-4 mb-3 relative">
            <div class="flex items-center gap-4 flex-grow">
                <h1 class="text-3xl font-bold tracking-widest text-stone-800 cursor-pointer flex-shrink-0" onclick="resetSearch()">Vibeè«–èª</h1>

                <!-- Expanding Search Bar -->
                <div id="searchContainer" class="relative flex items-center transition-all duration-300 ease-in-out">
                    <button id="searchIconBtn" onclick="toggleSearch()" class="text-stone-600 hover:text-stone-800 p-2 rounded-full hover:bg-stone-200 transition-colors z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    <div id="searchInputWrapper" class="absolute left-0 top-0 h-full flex items-center overflow-hidden transition-all duration-300 ease-in-out w-0 opacity-0 bg-stone-100 rounded-full">
                        <input type="text" id="searchInput" placeholder="æœå°‹..."
                            class="w-full h-full bg-transparent border-none focus:ring-0 px-10 text-stone-700 font-sans text-sm"
                            onblur="checkCollapseSearch()">
                        <button id="searchClearBtn" class="absolute right-2 text-stone-400 hover:text-stone-600 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Actions (Visible < md) -->
            <div class="flex items-center gap-2 md:hidden">
                <button onclick="toggleMobileMenu()" class="bg-stone-200 text-stone-700 px-3 py-2 rounded-lg hover:bg-stone-300 transition-colors flex items-center gap-1 text-sm font-sans">
                    â˜°
                </button>
            </div>

            <!-- Desktop Nav & Mobile Menu (Hidden < md, Flex >= md) -->
            <div id="navMenu" class="hidden w-full md:flex md:w-auto md:items-center gap-2 flex-col md:flex-row">
                <button onclick="openCharacterModal()" class="whitespace-nowrap bg-stone-200 text-stone-700 px-3 py-2 rounded-lg hover:bg-stone-300 transition-colors flex items-center gap-1 text-sm font-sans w-full md:w-auto justify-center md:justify-start">
                    ğŸ§‘ äººç‰©åˆ—è¡¨
                </button>
                <button onclick="openAskModal()" class="whitespace-nowrap bg-stone-800 text-white px-3 py-2 rounded-lg hover:bg-stone-700 transition-colors flex items-center gap-1 shadow-md text-sm font-sans w-full md:w-auto justify-center md:justify-start">
                    âœ¨ AIå­”å­
                </button>
                <button onclick="openHashtagModal()"
                    class="whitespace-nowrap bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg hover:bg-indigo-200 transition-colors flex items-center gap-1 text-sm font-sans w-full md:w-auto justify-center md:justify-start">
                    ğŸ·ï¸ æ¨™ç±¤
                </button>
                <button onclick="toggleTranslations()" id="translationToggleBtn"
                    class="whitespace-nowrap bg-stone-200 text-stone-700 px-3 py-2 rounded-lg hover:bg-stone-300 transition-colors flex items-center gap-1 text-sm font-sans w-full md:w-auto justify-center md:justify-start">
                    ğŸ“– è¨»è§£
                </button>
                <div class="relative inline-block text-left w-full md:w-auto">
                    <select id="sortSelect" onchange="handleSortChange(this.value)"
                        class="appearance-none bg-stone-200 text-stone-700 px-3 py-2 pr-8 rounded-lg hover:bg-stone-300 transition-colors text-sm font-sans cursor-pointer focus:outline-none focus:ring-2 focus:ring-stone-500 w-full md:w-auto">
                        <option value="hashtag" selected>ğŸ·ï¸ æ¨™ç±¤å„ªå…ˆ</option>
                        <option value="sequential">ğŸ“š å‚³çµ±ç¯‡ç« é †åº</option>
                        <option value="random">ğŸ² éš¨æ©Ÿæ’åº</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Filter Indicator (Visible in main view) -->
        <div id="mainFilterIndicator"
            class="hidden bg-stone-700 text-white px-3 py-1.5 rounded-lg text-sm flex items-center justify-between gap-2 mt-2">
            <span id="mainFilterText" class="font-bold"></span>
            <button onclick="clearFilter()" class="hover:text-red-300 text-stone-300">âœ• æ¸…é™¤</button>
        </div>

        <!-- Character Biography Container -->
        <div id="characterBio"
            class="hidden mt-3 p-4 bg-stone-100 rounded-lg border border-stone-200 text-stone-700 text-sm leading-relaxed font-sans shadow-inner">
            <!-- Populated by JS -->
        </div>

        <div id="resultCount" class="text-sm text-stone-500 mt-2 text-right font-sans">é¡¯ç¤ºå…¨éƒ¨æ¢ç›®</div>
    </header>

    <!-- Main Content List -->
    <main class="w-full max-w-4xl p-4 md:p-6 space-y-6 mb-10" id="contentList">
        <!-- Javascript will populate this -->
        <div class="text-center text-gray-500 py-10">è³‡æ–™è¼‰å…¥ä¸­...</div>
    </main>
    <!-- Character Modal -->
    <div id="characterModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[95vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center bg-stone-50 gap-4 relative">
                <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
                    <h3 class="text-xl font-bold text-stone-800 font-sans whitespace-nowrap">è«–èªäººç‰©èªŒ</h3>
                    <div id="categoryFilterContainer" class="flex gap-2 flex-wrap justify-center md:justify-start">
                        <button onclick="filterCharacterList('all')" data-category="all"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-800 text-white transition-colors border border-stone-300 shadow-sm">å…¨éƒ¨</button>
                        <button onclick="filterCharacterList('å­”é–€è«¸è³¢')" data-category="å­”é–€è«¸è³¢"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-200 text-stone-600 hover:bg-stone-300 transition-colors border border-stone-300 shadow-sm">å­”é–€è«¸è³¢</button>
                        <button onclick="filterCharacterList('é­¯åœ‹äºº')" data-category="é­¯åœ‹äºº"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-200 text-stone-600 hover:bg-stone-300 transition-colors border border-stone-300 shadow-sm">é­¯åœ‹äºº</button>
                        <button onclick="filterCharacterList('å¤–åœ‹äºº')" data-category="å¤–åœ‹äºº"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-200 text-stone-600 hover:bg-stone-300 transition-colors border border-stone-300 shadow-sm">å¤–åœ‹äºº</button>
                        <button onclick="filterCharacterList('å¤äºº')" data-category="å¤äºº"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-200 text-stone-600 hover:bg-stone-300 transition-colors border border-stone-300 shadow-sm">å¤äºº</button>
                        <button onclick="filterCharacterList('å…¶ä»–')" data-category="å…¶ä»–"
                            class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-sans bg-stone-200 text-stone-600 hover:bg-stone-300 transition-colors border border-stone-300 shadow-sm">å…¶ä»–</button>
                    </div>
                </div>
                <button onclick="closeCharacterModal()" class="text-gray-500 hover:text-gray-700 text-2xl absolute top-2 right-4 md:static">&times;</button>
            </div>
            <div class="flex-grow bg-stone-800/80 backdrop-blur-sm overflow-hidden relative">
                <!-- Horizontal Scroll Container -->
                <div id="characterCardContainer" class="card-scroll-container">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Scroll Buttons -->
                <button onclick="scrollCards('left')" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-stone-700/50 hover:bg-stone-700/80 text-white p-3 rounded-full backdrop-blur-sm transition-all z-10 focus:outline-none shadow-lg border border-white/20 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button onclick="scrollCards('right')" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-stone-700/50 hover:bg-stone-700/80 text-white p-3 rounded-full backdrop-blur-sm transition-all z-10 focus:outline-none shadow-lg border border-white/20 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Ask Modal -->
    <div id="askModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-stone-50">
                <h3 class="text-xl font-bold text-stone-800">âœ¨ å‘ AI å­”å­è«‹æ•™</h3>
                <button onclick="closeAskModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow" id="askModalContent">
                <div class="bg-stone-100 p-4 rounded-lg mb-4 text-stone-700">
                    å¤«å­ä¹‹é“ï¼Œå¿ æ•è€Œå·²ã€‚ä½ æœ‰ä»€éº¼äººç”Ÿçš„ç–‘æƒ‘ï¼Œä¸å¦¨èªªä¾†è½è½ï¼Ÿ
                    <br><span class="text-xs text-stone-500 mt-2 block">(ä¾‹å¦‚ï¼šã€Œå¦‚ä½•é¢å°å¤±æ•—ï¼Ÿã€ã€ã€Œä»€éº¼æ˜¯çœŸæ­£çš„æœ‹å‹ï¼Ÿã€)</span>
                </div>
                <div id="aiChatResponse" class="markdown-body text-gray-800 text-lg leading-relaxed hidden"></div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="flex gap-2">
                    <input type="text" id="askInput" class="flex-grow p-3 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-500 font-sans" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...">
                    <button onclick="askConfucius()" class="bg-stone-800 text-white px-6 py-2 rounded-lg hover:bg-stone-700 transition-colors font-bold font-sans">è«‹æ•™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hashtag Modal -->
    <div id="hashtagModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-stone-50">
                <h3 class="text-xl font-bold text-stone-800 font-sans">ğŸ·ï¸ æœ‰è¶£æ¨™ç±¤</h3>
                <button onclick="closeHashtagModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-stone-50">
                <div id="hashtagListContainer" class="flex flex-wrap gap-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full text-center py-6 text-stone-400 text-sm border-t border-stone-300 font-sans">
        <p>Vibeè«–èª &copy; 2025</p>
        <button onclick="setApiKey()" class="mt-2 text-xs text-stone-300 hover:text-stone-500 underline">è¨­å®š Gemini API Key</button>
    </footer>

    <!-- Tooltip Element -->
    <div id="tooltip"></div>
    <script src="lunyu_data.js"></script>
    <script>
        // ------------------------------------------------------------------
        // è³‡æ–™è¨­å®šï¼šé›£å­—è¡¨ & äººç‰©è³‡æ–™åº«
        // ------------------------------------------------------------------

            let rareWordsMap = {};
            let rarePhrasesMap = {};
            let charactersDB = [];

            async function loadData() {
                try {
                    const [rWords, rPhrases, chars] = await Promise.all([
                        fetch('rareWords.json').then(r => r.json()),
                        fetch('rarePhrases.json').then(r => r.json()),
                        fetch('characters.json').then(r => r.json())
                    ]);
                    rareWordsMap = rWords;
                    rarePhrasesMap = rPhrases;
                    charactersDB = chars;
                    initApp();
                } catch (e) {
                    console.error("Failed to load data:", e);
                    document.getElementById('contentList').innerHTML = '<div class="text-center text-red-500 py-10">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–æª”æ¡ˆè·¯å¾‘ã€‚</div>';
                }
            }

        // ------------------------------------------------------------------
        // API Key è¨­å®š (å„ªå…ˆä½¿ç”¨ localStorageï¼Œå¦å‰‡ä½¿ç”¨é è¨­)
        // æ³¨æ„ï¼šåœ¨é è¦½ç’°å¢ƒä¸­ï¼Œç³»çµ±æœƒè‡ªå‹•æ³¨å…¥ Keyã€‚è‹¥æ˜¯ä¸‹è¼‰ä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€è¦è‡ªè¡Œè¨­å®šã€‚
        const defaultApiKey = "";
        let userApiKey = localStorage.getItem('gemini_api_key') || defaultApiKey;
        let activeCharFilter = null; // ç•¶å‰éæ¿¾çš„äººç‰©

        let activeHashtagFilter = null; // ç•¶å‰éæ¿¾çš„æ¨™ç±¤
        let currentSortType = 'hashtag'; // Default sort type
        let showTranslations = false; // Default hidden

        function toggleTranslations() {
            showTranslations = !showTranslations;
            const btn = document.getElementById('translationToggleBtn');
            const contentList = document.getElementById('contentList');

            if (showTranslations) {
                contentList.classList.add('show-translations');
                btn.innerHTML = 'ğŸ“– éš±è—ç¿»è­¯';
                btn.classList.remove('bg-stone-200', 'text-stone-700');
                btn.classList.add('bg-stone-800', 'text-white');
            } else {
                contentList.classList.remove('show-translations');
                btn.innerHTML = 'ğŸ“– é¡¯ç¤ºç¿»è­¯';
                btn.classList.remove('bg-stone-800', 'text-white');
                btn.classList.add('bg-stone-200', 'text-stone-700');
            }
        }

        function setApiKey() {
            const key = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key:", userApiKey);
            if (key !== null) {
                userApiKey = key;
                localStorage.setItem('gemini_api_key', key);
                alert("API Key å·²å„²å­˜");
            }
        }

        async function callGemini(prompt, systemInstruction = "") {
            const apiKey = userApiKey || defaultApiKey;
            if (!apiKey) {
                const key = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key ä»¥ä½¿ç”¨ AI åŠŸèƒ½:");
                if(key) {
                    userApiKey = key;
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    throw new Error("éœ€è¦ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½");
                }
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            // Retry logic
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }

        // ç¾…é¦¬æ•¸å­—è½‰æ›è¡¨
        const romanNumerals = [
            "", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X",
            "XI", "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX"
        ];

        // è«–èªæ•¸æ“šçµæ§‹ (ç²¾ç°¡ç‰ˆï¼ŒåŒ…å«å®Œæ•´20ç¯‡çš„æ ¸å¿ƒå…§å®¹çµæ§‹)
        // ç‚ºäº†ç¢ºä¿å–®ä¸€æª”æ¡ˆå¯åŸ·è¡Œä¸”æµæš¢ï¼Œé€™è£¡è¼‰å…¥äº†å®Œæ•´çš„ç« ç¯€æ•¸æ“šã€‚
        // è«–èªæ•¸æ“šçµæ§‹ (ç²¾ç°¡ç‰ˆï¼ŒåŒ…å«å®Œæ•´20ç¯‡çš„æ ¸å¿ƒå…§å®¹çµæ§‹)
        // ç‚ºäº†ç¢ºä¿å–®ä¸€æª”æ¡ˆå¯åŸ·è¡Œä¸”æµæš¢ï¼Œé€™è£¡è¼‰å…¥äº†å®Œæ•´çš„ç« ç¯€æ•¸æ“šã€‚
        const lunyuData = LUNYU_DATA;

        // æ‰å¹³åŒ–è³‡æ–™çµæ§‹ä»¥åˆ©æœå°‹
        let flatIndex = [];
        let globalCounter = 0;

        function processTextWithRuby(text) {
            let processed = text;

            // 1. è™•ç†è©çµ„ (å„ªå…ˆ)
            for (const [phrase, parts] of Object.entries(rarePhrasesMap)) {
                if (processed.includes(phrase)) {
                    let rubyHtml = "<ruby>";
                    for(let i=0; i<parts.length; i+=2) {
                        rubyHtml += `${parts[i]}<rt>${parts[i+1]}</rt>`;
                    }
                    rubyHtml += "</ruby>";
                    processed = processed.split(phrase).join(rubyHtml);
                }
            }

            // 2. è™•ç†å–®å­— (æ’é™¤å·²ç¶“åœ¨ ruby æ¨™ç±¤å…§çš„å­—)
            // ç”±æ–¼è©çµ„å·²ç¶“æ›¿æ›æˆ HTMLï¼Œæˆ‘å€‘åªæ›¿æ›å°šæœªè¢«æ¨™è¨˜çš„å–®å­—
            for (const [char, info] of Object.entries(rareWordsMap)) {
                 // ç°¡å–®çš„æ­£å‰‡ï¼šæ›¿æ›ä¸åœ¨ < > å…§çš„å­— (é€™æ˜¯ä¸€å€‹ç°¡åŒ–æ–¹æ¡ˆ)
                 const regex = new RegExp(`(?<!<[^>]*)(${char})(?![^<]*>)`, 'g');

                const zhuyin = info.zhuyin || "";
                const definition = info.definition ? info.definition.replace(/'/g, "\\'") : "";

                let replacement = "";
                if (zhuyin) {
                    replacement = `<ruby class="rare-char" onclick="showTooltip(event, this, '${char}', '${zhuyin}', '${definition}')">${char}<rt>${zhuyin}</rt></ruby>`;
                } else {
                    // No zhuyin, still make it clickable for definition, but no <rt>
                    replacement = `<span class="rare-char" onclick="showTooltip(event, this, '${char}', '', '${definition}')">${char}</span>`;
                }

                 processed = processed.replace(regex, replacement);
            }

            return processed;
        }

        // Tooltip Logic
        const tooltip = document.getElementById('tooltip');

        function showTooltip(event, element, char, zhuyin, definition) {
            event.stopPropagation(); // Prevent bubbling

            let zhuyinHtml = "";
            if (zhuyin && zhuyin !== "undefined") {
                zhuyinHtml = `<span class="text-sm text-stone-400 font-normal font-sans">${zhuyin}</span>`;
            }

            tooltip.innerHTML = `
                <div class="font-bold text-yellow-400 mb-1 flex items-baseline gap-2">
                    <span class="text-lg">${char}</span>
                    ${zhuyinHtml}
                </div>
                <div class="text-stone-200">${definition}</div>
            `;

            tooltip.style.display = 'block';

            // Positioning
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

            // Position above the character
            let top = rect.top + scrollTop - tooltipRect.height - 8;
            let left = rect.left + scrollLeft + (rect.width / 2) - (tooltipRect.width / 2);

            // Prevent going off screen
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < scrollTop) {
                // If not enough space above, show below
                top = rect.bottom + scrollTop + 8;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function hideTooltip() {
            if(tooltip) tooltip.style.display = 'none';
        }

        // Close tooltip when clicking anywhere else
        document.addEventListener('click', hideTooltip);
        window.addEventListener('scroll', hideTooltip);
        function identifyCharacters(text) {
            const tags = new Set();
            charactersDB.forEach(char => {
                // æª¢æŸ¥è©²äººç‰©çš„æ‰€æœ‰åˆ¥ç¨±
                // æ’é™¤ "å­" é€™ç¨®å¤ªé€šç”¨çš„å­—ï¼Œé™¤éæ˜¯ç‰¹å®šèªå¢ƒ (é€™è£¡ä¸»è¦ä¾è³´ searchKeys é™£åˆ—çš„æº–ç¢ºæ€§)
                const searchKeys = [...char.searchKeys];

                // å¦‚æœæ˜¯å­”å­ï¼Œé¿å…æ¯å¥è©±ã€Œå­æ›°ã€éƒ½æ¨™ç±¤å­”å­ï¼Œå› ç‚ºå¤ªæ°¾æ¿«ã€‚
                // é€šå¸¸æˆ‘å€‘åªæ¨™ç±¤å­”å­èˆ‡ä»–äººäº’å‹•ï¼Œæˆ–è€…ç‰¹å®šç¨±è¬‚å¦‚ã€Œä¸˜ã€ã€‚
                // é€™è£¡ç°¡åŒ–ï¼šè‹¥å‡ºç¾åå­—æ‰æ¨™ç±¤

                for (const alias of searchKeys) {
                    if (text.includes(alias)) {
                        tags.add(char.goBy); // åŠ å…¥çµ±ä¸€çš„å¸¸ç”¨ç¨±è¬‚
                        break; // æ‰¾åˆ°ä¸€å€‹åˆ¥ç¨±å°±å¤ äº†
                    }
                }
            });
            return Array.from(tags);
        }

            function initApp() {
            lunyuData.forEach(chapterData => {
                chapterData.verses.forEach((verseData, index) => {
                    globalCounter++;

                    let verseText = "";
                    let manualTags = [];
                    let translation = "";

                    if (typeof verseData === 'string') {
                        verseText = verseData;
                    } else {
                        verseText = verseData.text;
                        manualTags = verseData.tags || [];
                        translation = verseData.translation || "";
                    }

                    const charTags = identifyCharacters(verseText);
                    const rubyText = processTextWithRuby(verseText);

                    flatIndex.push({
                        globalId: globalCounter,
                        citation: `${chapterData.chapter} ${chapterData.roman}-${index + 1}`,
                        shortCitation: `${chapterData.roman}-${index + 1}`,
                        fullCitation: `${globalCounter} ${chapterData.chapter} ${chapterData.roman}-${index + 1}`,
                        rawText: verseText,
                        rubyText: rubyText,
                        charTags: charTags,
                        manualTags: manualTags,
                        translation: translation,
                        tags: [...charTags] // Keep for backward compatibility if needed, or just use charTags
                    });
                });
            });

                // Initial sort
                sortData(flatIndex, currentSortType);
            render(flatIndex);
        }

            function handleSortChange(sortType) {
                currentSortType = sortType;
                sortData(flatIndex, currentSortType);

                if (searchInput.value.trim()) {
                    searchInput.dispatchEvent(new Event('input'));
                } else if (activeCharFilter) {
                    filterByChar(activeCharFilter);
                } else if (activeHashtagFilter) {
                    filterByHashtag(activeHashtagFilter);
                } else {
                    render(flatIndex);
                }
            }

            function sortData(data, sortType) {
                if (sortType === 'random') {
                    // Fisher-Yates Shuffle
                    for (let i = data.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [data[i], data[j]] = [data[j], data[i]];
                    }
                } else if (sortType === 'sequential') {
                    data.sort((a, b) => a.globalId - b.globalId);
                } else if (sortType === 'hashtag') {
                    // 1. Split into two groups
                    const withTags = [];
                    const withoutTags = [];

                    data.forEach(item => {
                        if (item.manualTags && item.manualTags.length > 0) {
                            withTags.push(item);
                        } else {
                            withoutTags.push(item);
                        }
                    });

                    // 2. Shuffle both groups (Fisher-Yates)
                    function shuffle(array) {
                        for (let i = array.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [array[i], array[j]] = [array[j], array[i]];
                        }
                        return array;
                    }

                    shuffle(withTags);
                    shuffle(withoutTags);

                    // 3. Combine and update original array
                    const sorted = [...withTags, ...withoutTags];

                    // Update the input array in-place
                    for (let i = 0; i < data.length; i++) {
                        data[i] = sorted[i];
                    }
                }
            }

        // DOM å…ƒç´ 
        const searchInput = document.getElementById('searchInput');
                const searchClearBtn = document.getElementById('searchClearBtn');
        const contentList = document.getElementById('contentList');
        const resultCount = document.getElementById('resultCount');

    // Filter Indicators
    const mainFilterIndicator = document.getElementById('mainFilterIndicator');
            const mainFilterText = document.getElementById('mainFilterText');
        const characterBio = document.getElementById('characterBio');



            function updateMainIndicator() {
                const keyword = searchInput.value.trim();
                const hasCharFilter = !!activeCharFilter;
                const hasHashtagFilter = !!activeHashtagFilter;
                const hasSearch = !!keyword;

                if (!hasCharFilter && !hasHashtagFilter && !hasSearch) {
                    mainFilterIndicator.classList.add('hidden');
                    return;
                }

                mainFilterIndicator.classList.remove('hidden');

                let text = '';
                let parts = [];
                if (hasSearch) parts.push(`æœå°‹: ${keyword}`);
                if (hasCharFilter) parts.push(`äººç‰©: ${activeCharFilter}`);
                if (hasHashtagFilter) parts.push(`æ¨™ç±¤: #${activeHashtagFilter}`);

                text = parts.join(' + ');

                mainFilterText.textContent = text;
            }

    // Search Bar Expansion Logic
    const searchContainer = document.getElementById('searchContainer');
    const searchInputWrapper = document.getElementById('searchInputWrapper');

    function toggleSearch() {
        const isExpanded = searchInputWrapper.classList.contains('w-full');

        if (isExpanded) {
            // If already expanded and empty, collapse. If not empty, maybe just focus?
            // Actually, clicking the icon when expanded might mean "close" or "search".
            // Since we have a clear button, let's make the icon toggle collapse if empty.
            if (!searchInput.value.trim()) {
                collapseSearch();
            } else {
                searchInput.focus();
            }
        } else {
            expandSearch();
        }
    }

    function expandSearch() {
        searchInputWrapper.classList.remove('w-0', 'opacity-0');
        searchInputWrapper.classList.add('w-full', 'opacity-100');
        // On mobile, we might want to expand the container to take more space?
        // For now, let's rely on the wrapper filling the container.
        // But the container itself is inside a flex row.
        // We might need to add a class to the container to make it grow.
        searchContainer.classList.add('flex-grow');
        // And maybe hide the title on mobile if needed?
        // For now, let's see how it looks.

        setTimeout(() => searchInput.focus(), 50);
    }

    function collapseSearch() {
        searchInputWrapper.classList.remove('w-full', 'opacity-100');
        searchInputWrapper.classList.add('w-0', 'opacity-0');
        searchContainer.classList.remove('flex-grow');
    }

    function checkCollapseSearch() {
        // Delay to allow click events on clear button or other elements to process
        setTimeout(() => {
            if (!searchInput.value.trim() && document.activeElement !== searchInput) {
                collapseSearch();
            }
        }, 200);
    }

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            if (document.activeElement === searchInput) {
                searchInput.blur();
                collapseSearch();
            }
            closeCharacterModal();
            closeAskModal();
            closeHashtagModal();
        }
    });
        async function explainVerse(btn, citation, text) {
            const card = btn.closest('.verse-card');
            let explanationDiv = card.querySelector('.ai-explanation');

            if (!explanationDiv) {
                explanationDiv = document.createElement('div');
                explanationDiv.className = 'ai-explanation mt-4 p-4 bg-stone-50 rounded-lg border border-stone-200 text-stone-700 text-base font-sans';
                explanationDiv.style.display = 'none';
                card.appendChild(explanationDiv);
            }

            if (explanationDiv.style.display !== 'none') {
                explanationDiv.style.display = 'none';
                btn.innerHTML = 'âœ¨ AI ç™½è©±è§£è®€';
                return;
            }

            explanationDiv.style.display = 'block';
            explanationDiv.innerHTML = '<div class="flex items-center gap-2"><div class="animate-spin h-4 w-4 border-2 border-stone-500 rounded-full border-t-transparent"></div> æ­£åœ¨è«‹æ•™ AI å¤«å­...</div>';
            btn.innerHTML = 'æ”¶èµ·è§£è®€';

            try {
                const prompt = `è«‹ç”¨å¹³æ˜“è¿‘äººçš„ç¾ä»£ç¹é«”ä¸­æ–‡è§£é‡‹é€™å¥è«–èªï¼šã€Œ${text}ã€ã€‚\n1. å…ˆçµ¦å‡ºç™½è©±ç¿»è­¯ã€‚\n2. å†ç°¡è¦èªªæ˜é€™å¥è©±çš„ç¾ä»£æ‡‰ç”¨æˆ–æ ¸å¿ƒå“²ç†ã€‚`;
                const systemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šåœ‹å­¸çš„ç¾ä»£è¬›å¸«ï¼Œæ“…é•·å°‡è«–èªæ™ºæ…§æ‡‰ç”¨æ–¼ç¾ä»£ç”Ÿæ´»ã€‚";

                const result = await callGemini(prompt, systemPrompt);
                explanationDiv.innerHTML = marked.parse(result);
            } catch (error) {
                explanationDiv.innerHTML = `<span class="text-red-500">ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}ã€‚è«‹ç¢ºèªä¸‹æ–¹çš„ API Key è¨­å®šã€‚</span>`;
                console.error(error);
            }
        }

        // æ¸²æŸ“å‡½æ•¸
        function render(results, keyword = '') {
            contentList.innerHTML = '';

            if (results.length === 0) {
                contentList.innerHTML = '<div class="text-center text-gray-500 py-10 font-sans">æ‰¾ä¸åˆ°ç›¸é—œæ¢ç›®ã€‚</div>';
                resultCount.textContent = 'ç„¡æœå°‹çµæœ';
                return;
            }

            resultCount.textContent = `é¡¯ç¤º ${results.length} ç­†æ¢ç›®`;

            const fragment = document.createDocumentFragment();

            results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'verse-card bg-white p-6 rounded shadow-md border-l-4 border-stone-400 hover:shadow-lg transition-shadow relative';

                // è™•ç†æœå°‹é—œéµå­—é«˜äº®
                // æ³¨æ„ï¼šé€™æ¯”è¼ƒè¤‡é›œï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“æœ‰äº† ruby HTMLã€‚
                // ç°¡å–®ä½œæ³•ï¼šå…ˆä½¿ç”¨ rubyTextï¼Œç„¶å¾Œå˜—è©¦åœ¨æ¨™ç±¤å¤–é€²è¡Œæ›¿æ›ã€‚
                // ä½†ç‚ºäº†ç©©å¥æ€§ï¼Œå¦‚æœæ²’æœ‰æœå°‹é—œéµå­—ï¼Œç›´æ¥é¡¯ç¤º rubyTextã€‚
                // å¦‚æœæœ‰æœå°‹é—œéµå­—ï¼Œç‚ºé¿å…ç ´å£ ruby çµæ§‹ï¼Œæˆ‘å€‘åƒ…åœ¨é—œéµå­—ä¸åœ¨ ruby æ¨™ç±¤å…§æ™‚é«˜äº®ï¼Œæˆ–è€…ç°¡åŒ–è™•ç†ã€‚
                // *é€²éšå„ªåŒ–*ï¼šé€™è£¡ç‚ºäº†ä»£ç¢¼ä¸è‡³æ–¼éåº¦è¤‡é›œï¼Œæˆ‘å€‘æ¡å–ã€Œä¸ç ´å£HTMLã€çš„æ­£å‰‡æ›¿æ›ã€‚

                let displayText = item.rubyText;

                if (keyword) {
                    // ä½¿ç”¨ Negative Lookahead ç¢ºä¿ä¸æ›¿æ› HTML tag å…§çš„æ–‡å­—
                    // é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ä¿è­·æ©Ÿåˆ¶
                    try {
                        const regex = new RegExp(`(?![^<]+>)(${keyword})`, 'gi');
                        displayText = displayText.replace(regex, `<span class="highlight">$1</span>`);
                    } catch(e) {
                        // Regex error fallback
                    }
                }

                // ç”¢ç”Ÿäººç‰©æ¨™ç±¤ HTML
                const charTagsHtml = item.charTags.map(tag => {
                    const charData = charactersDB.find(c => c.goBy === tag); // Changed from c.name to c.goBy to match existing DB structure
                    let categoryClass = '';
                    if (charData) {
                        if (charData.category === 'å­”é–€è«¸è³¢') categoryClass = 'tag-confucian';
                        else if (charData.category === 'å…¶ä»–') categoryClass = 'tag-other';
                        else if (charData.category === 'å¤äºº') categoryClass = 'tag-ancient';
                        else if (charData.category === 'é­¯åœ‹äºº') categoryClass = 'tag-lu';
                        else if (charData.category === 'å¤–åœ‹äºº') categoryClass = 'tag-foreign';
                    }

                    return `<span class="char-tag ${categoryClass} ${activeCharFilter === tag ? 'active' : ''}" onclick="filterByChar('${tag}')">${tag}</span>`;
                }).join(' ');

                // ç”¢ç”Ÿ Hashtag HTML
                const hashtagsHtml = item.manualTags.map(tag => {
                    return `<span class="hashtag ${activeHashtagFilter === tag ? 'active' : ''}" onclick="filterByHashtag('${tag}')">#${tag}</span>`;
                }).join(' ');

                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
                        <div class="flex flex-col gap-1 w-full">
                            <div class="text-sm font-bold text-stone-600 font-sans tracking-wide select-all">
                                <span class="serial-num mr-2">#${item.globalId}</span> ${item.citation}
                            </div>
                            <div class="flex flex-wrap gap-2 mt-1">
                                ${charTagsHtml}
                                ${hashtagsHtml}
                            </div>
                        </div>
                        <button onclick="explainVerse(this, '${item.citation}', '${item.rawText.replace(/'/g, "\\'")}')" class="text-xs bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1.5 rounded transition-colors flex items-center gap-1 font-sans border border-stone-200 whitespace-nowrap self-start sm:self-auto flex-shrink-0">
                            âœ¨ AI ç™½è©±è§£è®€
                        </button>
                    </div>
                    <div class="text-xl leading-loose text-gray-800 tracking-wide mt-2 pl-1 border-l-2 border-stone-100 break-words text-justify">${displayText}</div>
                    ${item.translation ? `<div class="translation-text">${item.translation}</div>` : ''}
                `;
                fragment.appendChild(card);
            });

            contentList.appendChild(fragment);
        }

        // ------------------------------------------------------------------
        // äººç‰©æ¨™ç±¤èˆ‡éæ¿¾åŠŸèƒ½
        // ------------------------------------------------------------------

        function filterByChar(charName) {
            activeCharFilter = charName;
            searchInput.value = ''; // æ¸…ç©ºæœå°‹æ¬„

            updateMainIndicator();

            // Show Character Bio
            const charData = charactersDB.find(c => c.goBy === charName);
            if (charData && charData.relation) {
                const wikiLink = charData.wikipedia ? `<a href="${charData.wikipedia}" target="_blank" class="text-stone-500 hover:text-stone-700 ml-2" title="ç¶­åŸºç™¾ç§‘"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>` : '';

                characterBio.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-bold text-lg text-stone-800">${charData.goBy}</span>
                        ${wikiLink}
                    </div>
                    <div>${charData.relation}</div>
                `;
                characterBio.classList.remove('hidden');
            } else {
                characterBio.classList.add('hidden');
            }

            const filtered = flatIndex.filter(item => item.charTags.includes(charName));

            // Ensure filtered list is also sorted according to current preference (though flatIndex is already sorted, filtering preserves order)
            render(filtered);

            // é—œé–‰äººç‰© Modal å¦‚æœé–‹è‘—
            closeCharacterModal();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

                    function filterByHashtag(tag) {
                        activeHashtagFilter = tag;
                        activeCharFilter = null; // Reset char filter
                        searchInput.value = '';

                        updateMainIndicator();

                        const filtered = flatIndex.filter(item => item.manualTags.includes(tag));

                        render(filtered);

                        closeHashtagModal();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }

        function clearFilter() {
            activeCharFilter = null;
            activeHashtagFilter = null;
            searchInput.value = '';

            characterBio.classList.add('hidden');

            updateMainIndicator();
            render(flatIndex);
        }

        function resetSearch() {
            clearFilter();
            render(flatIndex);
        }

        // ------------------------------------------------------------------
        // äººç‰©åˆ—è¡¨ Modal
        // ------------------------------------------------------------------

        const characterModal = document.getElementById('characterModal');

        // const characterTableBody = document.getElementById('characterTableBody'); // Removed

            let activeCategoryFilter = 'all';

            function filterCharacterList(category) {
                activeCategoryFilter = category;

                // Update button styles
                const buttons = document.querySelectorAll('#categoryFilterContainer button');
                buttons.forEach(btn => {
                    if (btn.dataset.category === category) {
                        btn.classList.remove('bg-stone-200', 'text-stone-600');
                        btn.classList.add('bg-stone-800', 'text-white');
                    } else {
                        btn.classList.add('bg-stone-200', 'text-stone-600');
                        btn.classList.remove('bg-stone-800', 'text-white');
                    }
                });

                renderCharacterCards();
            }

            function scrollCards(direction) {
                const container = document.getElementById('characterCardContainer');
                const scrollAmount = 340; // Card width (300) + gap (approx 40)

                if (direction === 'left') {
                    container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                } else {
                    container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                }
            }

            // Mouse Wheel Horizontal Scroll
            document.addEventListener('DOMContentLoaded', () => {
                const container = document.getElementById('characterCardContainer');
                if (container) {
                    container.addEventListener('wheel', (e) => {
                        // If we are scrolling vertically (deltaY), map it to horizontal
                        if (e.deltaY !== 0) {
                            e.preventDefault();
                            // Multiplier for "acceleration" / speed
                            const multiplier = 3;
                            container.scrollLeft += e.deltaY * multiplier;
                        }
                    }, { passive: false });
                }
            });

            function renderCharacterCards() {
                const filteredChars = activeCategoryFilter === 'all'
                    ? charactersDB
                    : charactersDB.filter(char => char.category === activeCategoryFilter);

                const container = document.getElementById('characterCardContainer');

                if (filteredChars.length === 0) {
                    container.innerHTML = '<div class="text-white text-xl w-full text-center">æ²’æœ‰æ‰¾åˆ°ç›¸é—œäººç‰©</div>';
                    return;
                }

                container.innerHTML = filteredChars.map(char => {
                    const rareness = calculateRareness(char.relation || "");
                    const stars = "â˜…".repeat(rareness) + "â˜†".repeat(5 - rareness);

                    // Generate a placeholder color or image based on name hash or category
                    const categoryColors = {
                        'å­”é–€è«¸è³¢': 'bg-amber-100 text-amber-800',
                        'é­¯åœ‹äºº': 'bg-lime-100 text-lime-800',
                        'å¤–åœ‹äºº': 'bg-sky-100 text-sky-800',
                        'å¤äºº': 'bg-slate-100 text-slate-800',
                        'å…¶ä»–': 'bg-stone-100 text-stone-800'
                    };
                    const colorClass = categoryColors[char.category] || 'bg-stone-200 text-stone-600';

                    const wikiLink = char.wikipedia ?
                        `<a href="${char.wikipedia}" target="_blank" class="text-stone-500 hover:text-stone-800 transition-colors" title="ç¶­åŸºç™¾ç§‘" onclick="event.stopPropagation()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>` : '';

                    const hasBoth = char.surname && char.cadet;
                    const surnameClass = hasBoth ? "text-stone-400" : "";

                    const surnameStr = char.surname ? `<span class="mr-0.5 ${surnameClass}">${char.surname}</span><span class="text-stone-400 text-[0.7rem] mr-2">å§“</span>` : '';
                    const cadetStr = char.cadet ? `<span class="mr-0.5">${char.cadet}</span><span class="text-stone-400 text-[0.7rem] mr-2">æ°</span>` : '';
                    const nameStr = char.name ? `<span class="text-stone-400 text-[0.7rem] mr-0.5">å</span><span class="mr-2">${char.name}</span>` : '';
                    const styleStr = char.style ? `<span class="text-stone-400 text-[0.7rem] mr-0.5">å­—</span><span>${char.style}</span>` : '';

                    const nameDisplayHtml = `<div class="flex flex-wrap items-baseline text-sm font-bold text-stone-700">
                        ${surnameStr}${cadetStr}${nameStr}${styleStr}
                    </div>`;

                    return `
                    <div class="pokemon-card rare-${rareness}">
                        <div class="card-header">
                            <span class="font-bold text-xl text-stone-800 font-serif">${char.goBy}</span>
                            <span class="text-yellow-500 text-sm tracking-widest" title="ç¨€æœ‰åº¦: ${rareness}">${stars}</span>
                        </div>

                        <div class="card-image-container">
                            <!-- Placeholder Image / Avatar -->
                            <div class="w-full h-full flex flex-col justify-center items-center ${colorClass} opacity-80">
                                <span class="text-4xl mb-2">ğŸ‘¤</span>
                                <span class="text-xs font-bold uppercase tracking-wider">${char.category || 'äººç‰©'}</span>
                            </div>
                        </div>

                        <div class="card-content scrollbar-hide">
                            <div class="mb-2 flex justify-between items-start border-b border-stone-200 pb-2">
                                ${nameDisplayHtml}
                                ${wikiLink}
                            </div>
                            <p class="text-stone-700 text-sm leading-relaxed text-justify">
                                ${char.relation || "æš«ç„¡ç°¡ä»‹"}
                            </p>
                        </div>

                        <div class="card-footer">
                            <span class="text-xs font-mono text-stone-400">NO.${String(filteredChars.indexOf(char) + 1).padStart(3, '0')}</span>
                            <button onclick="filterByChar('${char.goBy}')" class="text-xs bg-stone-800 text-white px-3 py-1 rounded-full hover:bg-stone-600 transition-colors">
                                æŸ¥çœ‹æ¢ç›®
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            function calculateRareness(description) {
                const len = description.length;
                if (len < 10) return 1;
                if (len < 30) return 2;
                if (len < 60) return 3;
                if (len < 100) return 4;
                return 5;
            }

            function openCharacterModal() {
                filterCharacterList('all');
            characterModal.classList.remove('hidden');
        }

        function closeCharacterModal() {
            characterModal.classList.add('hidden');
        }

                    // ------------------------------------------------------------------
                    // Hashtag Modal Logic
                    // ------------------------------------------------------------------
                    const hashtagModal = document.getElementById('hashtagModal');
                    const hashtagListContainer = document.getElementById('hashtagListContainer');

                    function openHashtagModal() {
                        // Collect all unique hashtags
                        const allTags = new Set();
                        flatIndex.forEach(item => {
                            item.manualTags.forEach(tag => allTags.add(tag));
                        });

                        if (allTags.size === 0) {
                            hashtagListContainer.innerHTML = '<div class="text-stone-500 w-full text-center">ç›®å‰æ²’æœ‰ä»»ä½•æ¨™ç±¤ã€‚</div>';
                        } else {
                            hashtagListContainer.innerHTML = Array.from(allTags).map(tag => `
                    <button onclick="filterByHashtag('${tag}')"
                        class="px-4 py-2 rounded-full text-base font-sans bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors border border-indigo-200 shadow-sm">
                        #${tag}
                    </button>
                `).join('');
                        }

                        hashtagModal.classList.remove('hidden');
                    }

                    function closeHashtagModal() {
                        hashtagModal.classList.add('hidden');
                    }

        // ------------------------------------------------------------------
        // AI å•ç­”åŠŸèƒ½ (ä¿ç•™åŸæ¨£)
        // ------------------------------------------------------------------
        const askModal = document.getElementById('askModal');
        const askInput = document.getElementById('askInput');
        const aiChatResponse = document.getElementById('aiChatResponse');

        function openAskModal() {
            askModal.classList.remove('hidden');
            askInput.focus();
        }

        function closeAskModal() {
            askModal.classList.add('hidden');
        }

        async function askConfucius() {
            const question = askInput.value.trim();
            if (!question) return;

            aiChatResponse.classList.remove('hidden');
            aiChatResponse.innerHTML = '<div class="flex justify-center py-8"><div class="animate-spin h-8 w-8 border-4 border-stone-800 rounded-full border-t-transparent"></div></div>';

            try {
                const prompt = `ä½¿ç”¨è€…å•é¡Œï¼šã€Œ${question}ã€\n\nè«‹æ ¹æ“šè«–èªçš„æ™ºæ…§å›ç­”é€™å€‹å•é¡Œã€‚è«‹å¼•ç”¨è‡³å°‘ä¸€å¥ç›¸é—œçš„è«–èªåŸæ–‡ä¾†ä½è­‰ä½ çš„å›ç­”ã€‚å›ç­”èªæ°£è¦æº«å’Œã€æœ‰æ™ºæ…§ï¼Œä¸¦ä»¥ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
                const systemPrompt = "ä½ æ˜¯ä¸€ä½å……æ»¿æ™ºæ…§çš„å„’å®¶å°å¸«ï¼Œç†Ÿæ‚‰ã€Šè«–èªã€‹å…¨æ–‡ã€‚è«‹ç”¨ç¾ä»£äººçš„èªè¨€ï¼Œçµåˆã€Šè«–èªã€‹çš„åŸæ–‡æ™ºæ…§ä¾†å›ç­”ä½¿ç”¨è€…çš„ç”Ÿæ´»ç–‘æƒ‘ã€‚";

                const result = await callGemini(prompt, systemPrompt);
                aiChatResponse.innerHTML = marked.parse(result);
            } catch (error) {
                aiChatResponse.innerHTML = `<div class="text-red-500 p-4 text-center">ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }

        askInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                askConfucius();
            }
        });

        askModal.addEventListener('click', function(e) {
            if (e.target === askModal) {
                closeAskModal();
            }
        });

        characterModal.addEventListener('click', function(e) {
            if (e.target === characterModal) {
                closeCharacterModal();
            }
        });

            // åˆå§‹åŒ–ï¼šè¼‰å…¥è³‡æ–™
            loadData();

                // æœå°‹äº‹ä»¶ç›£è½
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.trim();

            // Toggle clear button
            if (keyword) {
                searchClearBtn.classList.remove('hidden');
            } else {
                searchClearBtn.classList.add('hidden');
            }

            updateMainIndicator();

            // å¦‚æœæ­£åœ¨ä½¿ç”¨äººç‰©éæ¿¾ï¼Œå‰‡æœå°‹æ˜¯åœ¨è©²äººç‰©çµæœä¸­æœå°‹
            let baseList = activeCharFilter
                ? flatIndex.filter(item => item.tags.includes(activeCharFilter))
                : flatIndex;

            if (!keyword) {
                render(baseList);
                return;
            }

            const filtered = baseList.filter(item => item.rawText.includes(keyword) || item.shortCitation.includes(keyword));
            render(filtered, keyword);
        });

                // Clear button event listener
                searchClearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    searchClearBtn.classList.add('hidden');
                    searchInput.focus();

                    updateMainIndicator();

                    // Trigger search reset
                    let baseList = activeCharFilter
                        ? flatIndex.filter(item => item.tags.includes(activeCharFilter))
                        : flatIndex;
                    render(baseList);
                });

        function toggleMobileMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('hidden');
        }

    </script>
</body>
</html>
